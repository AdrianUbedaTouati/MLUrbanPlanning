{% extends 'core/base.html' %}
{% load static %}

{% block title %}{{ session.title|default:"Chat avec IA" }} - JobSearchAI{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'chat/css/chat.css' %}?v=3.0">
{% endblock %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-layout">
        <!-- Main Chat Area -->
        <div class="chat-main">
            <!-- Chat Header -->
            <div class="chat-header">
                <div>
                    <h1 class="chat-header-title">
                        {{ session.title|default:"Nouvelle Conversation" }}
                    </h1>
                </div>
                <div class="chat-header-actions">
                    <a href="{% url 'apps_chat:session_list' %}"
                       class="btn-icon"
                       title="Voir toutes les conversations"
                       data-bs-toggle="tooltip">
                        <i class="bi bi-list"></i>
                    </a>
                    <form method="post"
                          action="{% url 'apps_chat:session_archive' session.id %}"
                          class="d-inline">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn-icon"
                                title="Archiver la conversation"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-archive"></i>
                        </button>
                    </form>
                    <form method="post"
                          action="{% url 'apps_chat:session_delete' session.id %}"
                          class="d-inline"
                          onsubmit="return confirm('Etes-vous sur de vouloir supprimer cette conversation ?');">
                        {% csrf_token %}
                        <button type="submit"
                                class="btn-icon"
                                title="Supprimer la conversation"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-trash"></i>
                        </button>
                    </form>
                </div>
            </div>

            <!-- Chat Messages -->
            <div class="chat-messages" id="chatMessages">
                {% if messages %}
                    {% for msg in messages %}
                        {% include 'chat/partials/_message_bubble.html' %}
                    {% endfor %}
                {% else %}
                <div class="chat-empty-state">
                    <div class="chat-empty-icon">
                        <i class="bi bi-chat-dots"></i>
                    </div>
                    <h3 class="chat-empty-title">Commencez une conversation</h3>
                    <p class="chat-empty-text">
                        Vous pouvez me saluer, me poser des questions sur la recherche d'emploi, ou consulter des informations specifiques.
                        Je suis la pour vous aider avec l'analyse d'offres, expliquer des concepts, ou simplement discuter.
                    </p>
                </div>
                {% endif %}
            </div>


            <!-- Chat Input -->
            <div class="chat-input-container">
                <form method="post"
                      action="{% url 'apps_chat:message_create' session.id %}"
                      id="messageForm">
                    {% csrf_token %}
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input"
                                  name="message"
                                  id="messageInput"
                                  placeholder="Posez-moi des questions sur la recherche d'emploi ou discutez avec moi..."
                                  rows="1"
                                  required
                                  autocomplete="off"></textarea>
                        <button type="submit"
                                class="btn-send"
                                id="sendButton"
                                title="Envoyer le message (Enter)"
                                data-bs-toggle="tooltip">
                            <i class="bi bi-send-fill"></i>
                        </button>
                    </div>
                </form>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i>
                        Appuyez sur Entree pour envoyer, Shift+Entree pour une nouvelle ligne
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'chat/js/chat.js' %}?v=3.2.4"></script>
{% endblock %}
