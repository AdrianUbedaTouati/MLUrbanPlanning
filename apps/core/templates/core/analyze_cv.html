{% extends 'core/base.html' %}

{% block title %}Analyser le CV - BasePage{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-body p-5">
                    <h2 class="text-center mb-4">
                        <i class="bi bi-file-earmark-person"></i> Analyser le CV avec IA Vision
                    </h2>

                    <!-- Formulaire de telechargement -->
                    <div id="upload-section">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Comment ca fonctionne :</strong>
                            <ol class="mb-0 mt-2">
                                <li>Telechargez une image (JPG, PNG) ou un PDF de votre CV</li>
                                <li>GPT-4 Vision analysera le document et extraira vos informations</li>
                                <li>Un resume professionnel sera genere automatiquement</li>
                            </ol>
                        </div>

                        <form id="cv-form" method="post" enctype="multipart/form-data">
                            {% csrf_token %}

                            <div class="mb-4">
                                <label for="id_cv_file" class="form-label">
                                    <strong>{{ form.cv_file.label }}</strong>
                                </label>
                                {{ form.cv_file }}
                                {% if form.cv_file.help_text %}
                                    <small class="form-text text-muted">{{ form.cv_file.help_text }}</small>
                                {% endif %}
                                {% if form.cv_file.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.cv_file.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Note :</strong> L'image sera telechargee sur le serveur pour que GPT-4 Vision puisse l'analyser.
                                Assurez-vous que l'image est lisible et contient toutes les informations de votre CV.
                            </div>

                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-primary btn-lg" id="submit-btn">
                                    <i class="bi bi-cpu"></i> Analyser le CV
                                </button>
                                <a href="{% url 'apps_core:profile' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Retour au Profil
                                </a>
                            </div>
                        </form>
                    </div>

                    <!-- Section de progression -->
                    <div id="progress-section" style="display: none;">
                        <div class="text-center mb-4">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Traitement...</span>
                            </div>
                        </div>

                        <h4 class="text-center mb-4" id="progress-title">Traitement de votre CV...</h4>

                        <!-- Etapes du processus -->
                        <div class="list-group mb-4">
                            <div class="list-group-item d-flex align-items-center" id="step-1">
                                <span class="spinner-border spinner-border-sm me-3 text-primary step-spinner" style="display: none;"></span>
                                <i class="bi bi-circle me-3 step-pending"></i>
                                <i class="bi bi-check-circle-fill me-3 text-success step-done" style="display: none;"></i>
                                <span>Telechargement du fichier...</span>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step-2">
                                <span class="spinner-border spinner-border-sm me-3 text-primary step-spinner" style="display: none;"></span>
                                <i class="bi bi-circle me-3 step-pending"></i>
                                <i class="bi bi-check-circle-fill me-3 text-success step-done" style="display: none;"></i>
                                <span>Traitement de l'image...</span>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step-3">
                                <span class="spinner-border spinner-border-sm me-3 text-primary step-spinner" style="display: none;"></span>
                                <i class="bi bi-circle me-3 step-pending"></i>
                                <i class="bi bi-check-circle-fill me-3 text-success step-done" style="display: none;"></i>
                                <span>GPT-4 Vision extrait les informations...</span>
                            </div>
                            <div class="list-group-item d-flex align-items-center" id="step-4">
                                <span class="spinner-border spinner-border-sm me-3 text-primary step-spinner" style="display: none;"></span>
                                <i class="bi bi-circle me-3 step-pending"></i>
                                <i class="bi bi-check-circle-fill me-3 text-success step-done" style="display: none;"></i>
                                <span>Generation du resume professionnel...</span>
                            </div>
                        </div>

                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                                 style="width: 0%;" id="progress-bar">0%</div>
                        </div>

                        <p class="text-muted text-center" id="progress-message">
                            Ce processus peut prendre quelques secondes...
                        </p>
                    </div>

                    <!-- Section d'erreur -->
                    <div id="error-section" style="display: none;">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            <strong>Erreur lors de l'analyse du CV</strong>
                            <p class="mb-0 mt-2" id="error-message"></p>
                        </div>
                        <div class="d-grid">
                            <button class="btn btn-primary" onclick="location.reload()">
                                <i class="bi bi-arrow-repeat"></i> Reessayer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('cv-form');
    const uploadSection = document.getElementById('upload-section');
    const progressSection = document.getElementById('progress-section');
    const errorSection = document.getElementById('error-section');
    const progressBar = document.getElementById('progress-bar');
    const progressTitle = document.getElementById('progress-title');
    const progressMessage = document.getElementById('progress-message');
    const errorMessage = document.getElementById('error-message');

    function setStep(stepNum) {
        // Marquer les etapes precedentes comme terminees
        for (let i = 1; i < stepNum; i++) {
            const step = document.getElementById('step-' + i);
            step.querySelector('.step-spinner').style.display = 'none';
            step.querySelector('.step-pending').style.display = 'none';
            step.querySelector('.step-done').style.display = 'inline';
        }

        // Marquer l'etape actuelle comme en cours
        const currentStep = document.getElementById('step-' + stepNum);
        if (currentStep) {
            currentStep.querySelector('.step-spinner').style.display = 'inline-block';
            currentStep.querySelector('.step-pending').style.display = 'none';
        }

        // Mettre a jour la barre de progression
        const progress = (stepNum - 1) * 25;
        progressBar.style.width = progress + '%';
        progressBar.textContent = progress + '%';
    }

    function completeAllSteps() {
        for (let i = 1; i <= 4; i++) {
            const step = document.getElementById('step-' + i);
            step.querySelector('.step-spinner').style.display = 'none';
            step.querySelector('.step-pending').style.display = 'none';
            step.querySelector('.step-done').style.display = 'inline';
        }
        progressBar.style.width = '100%';
        progressBar.textContent = '100%';
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-success');
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Afficher la section de progression
        uploadSection.style.display = 'none';
        progressSection.style.display = 'block';

        // Demarrer l'etape 1
        setStep(1);
        progressMessage.textContent = 'Telechargement de votre fichier sur le serveur...';

        const formData = new FormData(form);

        // Simuler la progression pendant l'envoi
        setTimeout(() => {
            setStep(2);
            progressMessage.textContent = 'Traitement et preparation de l\'image...';
        }, 1000);

        setTimeout(() => {
            setStep(3);
            progressMessage.textContent = 'GPT-4 Vision analyse votre CV...';
        }, 2500);

        setTimeout(() => {
            setStep(4);
            progressMessage.textContent = 'Generation de votre resume professionnel...';
        }, 5000);

        // Envoyer le formulaire via AJAX
        fetch('{% url "apps_core:analyze_cv_ajax" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                completeAllSteps();
                progressTitle.textContent = 'Analyse terminee !';
                progressMessage.textContent = 'Redirection vers votre profil...';

                setTimeout(() => {
                    window.location.href = '{% url "apps_core:profile" %}';
                }, 1500);
            } else {
                progressSection.style.display = 'none';
                errorSection.style.display = 'block';
                errorMessage.textContent = data.error || 'Erreur inconnue lors du traitement du CV.';
            }
        })
        .catch(error => {
            progressSection.style.display = 'none';
            errorSection.style.display = 'block';
            errorMessage.textContent = 'Erreur de connexion. Veuillez reessayer.';
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
