{% extends 'core/base.html' %}

{% block title %}Mi Perfil - BasePage{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header -->
    <div class="text-center mb-4">
        <h2 class="fw-bold"><i class="bi bi-person-gear text-primary"></i> Mi Perfil</h2>
        <p class="text-muted">Configura tu cuenta, CV y preferencias de búsqueda</p>
    </div>

    {% if messages %}
    <div class="row justify-content-center mb-3">
        <div class="col-lg-10">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Sección 1: Configuración de Cuenta e IA -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-gear-fill"></i> Configuración</h5>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
                        {% endif %}

                        <div class="row">
                            <!-- Datos Personales -->
                            <div class="col-md-6 mb-4">
                                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-person-circle"></i> Datos Personales</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.first_name.label }}</label>
                                        {{ form.first_name }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.last_name.label }}</label>
                                        {{ form.last_name }}
                                    </div>
                                    <div class="col-12">
                                        <label class="form-label small">{{ form.email.label }} <span class="text-danger">*</span></label>
                                        {{ form.email }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.username.label }}</label>
                                        {{ form.username }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.phone.label }}</label>
                                        {{ form.phone }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.city.label }}</label>
                                        {{ form.city }}
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">{{ form.work_mode.label }}</label>
                                        {{ form.work_mode }}
                                    </div>
                                </div>
                            </div>

                            <!-- Configuración IA -->
                            <div class="col-md-6 mb-4">
                                <h6 class="fw-bold text-primary mb-3"><i class="bi bi-robot"></i> Inteligencia Artificial</h6>
                                <div class="bg-light rounded p-3">
                                    <div class="mb-2">
                                        <label class="form-label small">Proveedor</label>
                                        {{ form.llm_provider }}
                                    </div>

                                    <div class="mb-2" id="api_key_section">
                                        <label class="form-label small">API Key</label>
                                        {{ form.llm_api_key }}
                                    </div>

                                    <div class="mb-2" id="openai_model_section" style="display:none;">
                                        <label class="form-label small">Modelo</label>
                                        {{ form.openai_model }}
                                    </div>

                                    <div id="ollama_models_section" style="display:none;">
                                        <div class="mb-2">
                                            <label class="form-label small">Modelo Chat</label>
                                            <select name="ollama_model" class="form-select form-select-sm" id="ollama_chat_select">
                                                <option value="">Cargando...</option>
                                            </select>
                                        </div>
                                        <div class="mb-2">
                                            <label class="form-label small">Embeddings</label>
                                            <select name="ollama_embedding_model" class="form-select form-select-sm" id="ollama_embed_select">
                                                <option value="">Cargando...</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Búsqueda Web -->
                                    <div class="border-top pt-2 mt-2">
                                        <div class="form-check">
                                            {{ form.use_web_search }}
                                            <label class="form-check-label small" for="use_web_search_checkbox">
                                                <i class="bi bi-globe text-info"></i> Búsqueda Web
                                            </label>
                                        </div>
                                        <div id="google_search_credentials" style="display: none;" class="mt-2">
                                            <div class="mb-2">
                                                <label class="form-label small">Google API Key</label>
                                                {{ form.google_search_api_key }}
                                            </div>
                                            <div>
                                                <label class="form-label small">Search Engine ID</label>
                                                {{ form.google_search_engine_id }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-2 justify-content-end">
                            <a href="{% url 'apps_authentication:password_reset_request' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="bi bi-key"></i> Cambiar Contraseña
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Guardar Configuración
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sección 2: CV y Preferencias -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="row g-4">
                <!-- CV -->
                <div class="col-md-7">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="bi bi-file-earmark-person"></i> Mi Curriculum</h5>
                        </div>
                        <div class="card-body">
                            <!-- Subir CV -->
                            <div class="mb-4">
                                <h6 class="fw-bold small mb-2"><i class="bi bi-upload text-success"></i> Subir CV</h6>
                                {% if user.llm_provider == 'openai' and user.llm_api_key %}
                                <form method="post" action="{% url 'apps_core:analyze_cv' %}" enctype="multipart/form-data" id="cv_form">
                                    {% csrf_token %}
                                    <div class="input-group input-group-sm mb-1">
                                        <input type="file" name="cv_file" class="form-control" accept="image/*,.pdf" required>
                                        <button type="submit" class="btn btn-success" id="cv_submit_btn">
                                            <i class="bi bi-cpu"></i> Analizar
                                        </button>
                                    </div>
                                    <small class="text-muted">PDF o imagen - La IA leerá tu CV y lo transcribirá abajo</small>
                                </form>
                                {% else %}
                                <div class="alert alert-warning small py-2 mb-0">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    Configura <strong>OpenAI</strong> como proveedor de IA para analizar tu CV.
                                </div>
                                {% endif %}
                            </div>

                            <!-- Mi CV en texto -->
                            <div>
                                <h6 class="fw-bold small mb-2"><i class="bi bi-file-text text-primary"></i> Mi CV</h6>
                                <p class="text-muted small mb-2">
                                    Este texto es tu curriculum. Puedes escribirlo directamente o dejar que la IA lo extraiga al subir un archivo.
                                </p>
                                <form method="post" action="{% url 'apps_core:save_cv_text' %}">
                                    {% csrf_token %}
                                    <textarea name="curriculum_text" class="form-control form-control-sm mb-2" rows="8" placeholder="Escribe tu experiencia profesional:

• Datos personales
• Experiencia laboral
• Formación académica
• Habilidades técnicas
• Idiomas
• Qué tipo de trabajo buscas...">{{ user.job_profile.curriculum_text|default:'' }}</textarea>
                                    <div class="d-flex justify-content-between align-items-center">
                                        {% if user.job_profile and user.job_profile.cv_analyzed %}
                                        <small class="text-success"><i class="bi bi-check-circle"></i> Guardado {{ user.job_profile.updated_at|date:"d/m/Y" }}</small>
                                        {% else %}
                                        <small class="text-muted">Sin guardar</small>
                                        {% endif %}
                                        <button type="submit" class="btn btn-success btn-sm">
                                            <i class="bi bi-save"></i> Guardar CV
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferencias y Redes -->
                <div class="col-md-5">
                    <!-- Preferencias de Búsqueda -->
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-info text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-search-heart"></i> Preferencias</h6>
                        </div>
                        <div class="card-body py-3">
                            <form method="post" action="{% url 'apps_core:save_preferences' %}" id="preferences_form">
                                {% csrf_token %}

                                <div class="mb-2">
                                    <label class="form-label small mb-1">Ubicaciones</label>
                                    <div class="tags-container" id="locations_container">
                                        <input type="text" class="tags-input" id="locations_input" placeholder="Enter para añadir...">
                                    </div>
                                    <input type="hidden" name="preferred_locations" id="preferred_locations" value='{{ preferred_locations_json|default:"[]" }}'>
                                </div>

                                <div class="mb-2">
                                    <label class="form-label small mb-1">Sectores</label>
                                    <div class="tags-container" id="sectors_container">
                                        <input type="text" class="tags-input" id="sectors_input" placeholder="Enter para añadir...">
                                    </div>
                                    <input type="hidden" name="preferred_sectors" id="preferred_sectors" value='{{ preferred_sectors_json|default:"[]" }}'>
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Tipo trabajo</label>
                                        <div class="tags-container" id="job_types_container">
                                            <input type="text" class="tags-input" id="job_types_input" placeholder="Remoto...">
                                        </div>
                                        <input type="hidden" name="job_types" id="job_types" value='{{ job_types_json|default:"[]" }}'>
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small mb-1">Salario mín €</label>
                                        <input type="number" name="salary_min" class="form-control form-control-sm" value="{{ user.job_profile.salary_min|default:'' }}" placeholder="20000">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-info btn-sm w-100">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Redes Profesionales -->
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white py-2">
                            <h6 class="mb-0"><i class="bi bi-share"></i> Redes</h6>
                        </div>
                        <div class="card-body py-3">
                            <form method="post" action="{% url 'apps_core:save_social' %}" id="social_form">
                                {% csrf_token %}

                                <div class="mb-2">
                                    <label class="form-label small mb-1"><i class="bi bi-linkedin text-primary"></i> LinkedIn</label>
                                    <input type="url" name="linkedin_url" class="form-control form-control-sm" value="{{ user.job_profile.linkedin_url|default:'' }}" placeholder="https://linkedin.com/in/...">
                                </div>

                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <label class="form-label small mb-1"><i class="bi bi-github"></i> GitHub</label>
                                        <input type="url" name="github_url" class="form-control form-control-sm" value="{{ user.job_profile.github_url|default:'' }}" placeholder="github.com/...">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small mb-1"><i class="bi bi-globe2"></i> Web</label>
                                        <input type="url" name="portfolio_url" class="form-control form-control-sm" value="{{ user.job_profile.portfolio_url|default:'' }}" placeholder="tu-web.com">
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-dark btn-sm w-100">
                                    <i class="bi bi-save"></i> Guardar
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    align-items: center;
    min-height: 32px;
    padding: 4px 8px;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    background: white;
    cursor: text;
}
.tags-container:focus-within {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
}
.tag {
    background: #0d6efd;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 11px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.tag-remove {
    cursor: pointer;
    font-size: 12px;
    opacity: 0.8;
    line-height: 1;
}
.tag-remove:hover { opacity: 1; }
.tags-input {
    border: none;
    outline: none;
    flex: 1;
    min-width: 80px;
    font-size: 12px;
    padding: 2px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Provider toggle
    const providerSelect = document.getElementById('llm_provider_select');
    const chatSelect = document.getElementById('ollama_chat_select');
    const embedSelect = document.getElementById('ollama_embed_select');
    const currentChatModel = '{{ user.ollama_model|default:"qwen2.5:72b" }}';
    const currentEmbedModel = '{{ user.ollama_embedding_model|default:"nomic-embed-text" }}';

    async function loadOllamaModels() {
        try {
            const response = await fetch('{% url "apps_core:ollama_models" %}');
            const data = await response.json();
            if (data.success) {
                chatSelect.innerHTML = '';
                data.chat_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    if (model.name === currentChatModel) option.selected = true;
                    chatSelect.appendChild(option);
                });
                embedSelect.innerHTML = '';
                data.embedding_models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = model.name;
                    if (model.name === currentEmbedModel) option.selected = true;
                    embedSelect.appendChild(option);
                });
            }
        } catch (error) {
            chatSelect.innerHTML = '<option value="">Error</option>';
            embedSelect.innerHTML = '<option value="">Error</option>';
        }
    }

    function updateProviderInfo() {
        const provider = providerSelect.value;
        const apiKeySection = document.getElementById('api_key_section');
        const openaiModelSection = document.getElementById('openai_model_section');
        const ollamaModelsSection = document.getElementById('ollama_models_section');

        openaiModelSection.style.display = 'none';
        ollamaModelsSection.style.display = 'none';

        if (provider === 'ollama') {
            apiKeySection.style.display = 'none';
            ollamaModelsSection.style.display = 'block';
            loadOllamaModels();
        } else {
            apiKeySection.style.display = 'block';
            if (provider === 'openai') {
                openaiModelSection.style.display = 'block';
            }
        }
    }

    if (providerSelect) {
        providerSelect.addEventListener('change', updateProviderInfo);
        updateProviderInfo();
    }

    // Web search toggle
    const webSearchCheckbox = document.getElementById('use_web_search_checkbox');
    const googleSearchCredentials = document.getElementById('google_search_credentials');
    function toggleWebSearch() {
        if (webSearchCheckbox && googleSearchCredentials) {
            googleSearchCredentials.style.display = webSearchCheckbox.checked ? 'block' : 'none';
        }
    }
    if (webSearchCheckbox) {
        webSearchCheckbox.addEventListener('change', toggleWebSearch);
        toggleWebSearch();
    }

    // CV form spinner with processing indicator
    const cvForm = document.getElementById('cv_form');
    const cvBtn = document.getElementById('cv_submit_btn');
    if (cvForm && cvBtn) {
        cvForm.addEventListener('submit', function() {
            cvBtn.disabled = true;
            cvBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Analizando...';

            // Show processing message
            const processingAlert = document.createElement('div');
            processingAlert.id = 'cv_processing_alert';
            processingAlert.className = 'alert alert-info mt-2 py-2 small';
            processingAlert.innerHTML = '<i class="bi bi-hourglass-split"></i> <strong>Procesando CV...</strong> La IA está extrayendo el texto. Esto puede tardar hasta 1 minuto.';
            cvForm.parentNode.appendChild(processingAlert);
        });
    }

    // Tags functionality
    function initTags(containerId, inputId, hiddenId) {
        const container = document.getElementById(containerId);
        const input = document.getElementById(inputId);
        const hidden = document.getElementById(hiddenId);
        if (!container || !input || !hidden) return;

        let tags = [];
        try {
            tags = JSON.parse(hidden.value) || [];
        } catch (e) {
            tags = [];
        }

        function renderTags() {
            container.querySelectorAll('.tag').forEach(t => t.remove());
            tags.forEach((tag, index) => {
                const tagEl = document.createElement('span');
                tagEl.className = 'tag';
                tagEl.innerHTML = `${tag}<span class="tag-remove" data-index="${index}">&times;</span>`;
                container.insertBefore(tagEl, input);
            });
            hidden.value = JSON.stringify(tags);
        }

        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const value = this.value.trim();
                if (value && !tags.includes(value)) {
                    tags.push(value);
                    renderTags();
                }
                this.value = '';
            }
        });

        container.addEventListener('click', function(e) {
            if (e.target.classList.contains('tag-remove')) {
                tags.splice(parseInt(e.target.dataset.index), 1);
                renderTags();
            } else {
                input.focus();
            }
        });

        renderTags();
    }

    initTags('locations_container', 'locations_input', 'preferred_locations');
    initTags('sectors_container', 'sectors_input', 'preferred_sectors');
    initTags('job_types_container', 'job_types_input', 'job_types');
});
</script>
{% endblock %}
