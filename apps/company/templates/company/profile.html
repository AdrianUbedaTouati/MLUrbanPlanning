{% extends 'core/base.html' %}
{% load static %}

{% block title %}Mon Profil Professionnel{% endblock %}

{% block extra_css %}
<style>
    .profile-container {
        max-width: 900px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .profile-card {
        background: white;
        border-radius: 16px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
    }

    .profile-card h2 {
        font-size: 24px;
        font-weight: 600;
        color: #1d1d1f;
        margin-bottom: 8px;
    }

    .profile-card .subtitle {
        color: #86868b;
        font-size: 14px;
        margin-bottom: 24px;
    }

    .form-group {
        margin-bottom: 24px;
    }

    .form-label {
        display: block;
        font-weight: 500;
        color: #1d1d1f;
        margin-bottom: 8px;
        font-size: 15px;
    }

    .form-input, .form-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        font-size: 15px;
        transition: all 0.2s;
        background: white;
    }

    .form-input:focus, .form-select:focus {
        outline: none;
        border-color: #007aff;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    textarea.form-input {
        resize: vertical;
        min-height: 150px;
        font-family: inherit;
    }

    .help-text {
        font-size: 13px;
        color: #86868b;
        margin-top: 6px;
    }

    /* Tags Input */
    .tags-container {
        border: 1px solid #d2d2d7;
        border-radius: 8px;
        padding: 8px;
        min-height: 48px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        background: white;
        cursor: text;
    }

    .tags-container:focus-within {
        border-color: #007aff;
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .tag {
        background: #007aff;
        color: white;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .tag-remove {
        cursor: pointer;
        font-size: 16px;
        line-height: 1;
        opacity: 0.8;
    }

    .tag-remove:hover {
        opacity: 1;
    }

    .tags-input {
        border: none;
        outline: none;
        flex: 1;
        min-width: 120px;
        font-size: 14px;
        padding: 4px;
    }

    /* Buttons */
    .btn {
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
    }

    .btn-primary {
        background: #007aff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .btn-secondary {
        background: #f5f5f7;
        color: #1d1d1f;
    }

    .btn-secondary:hover {
        background: #e8e8ed;
    }

    .btn-success {
        background: #34c759;
        color: white;
    }

    .btn-success:hover {
        background: #2da44e;
    }

    /* Grid */
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }
    }

    /* Status badges */
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 500;
    }

    .status-complete {
        background: #d4edda;
        color: #155724;
    }

    .status-incomplete {
        background: #fff3cd;
        color: #856404;
    }

    /* CV Section */
    .cv-section {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
    }

    .cv-actions {
        display: flex;
        gap: 12px;
        margin-top: 16px;
    }

    /* Analyzed data */
    .analyzed-data {
        background: #e8f4fd;
        border-radius: 8px;
        padding: 16px;
        margin-top: 16px;
    }

    .analyzed-data h4 {
        color: #0056b3;
        margin-bottom: 12px;
        font-size: 14px;
    }

    .skill-tag {
        display: inline-block;
        background: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        margin: 2px;
        border: 1px solid #dee2e6;
    }

    /* Loading */
    .loading-spinner {
        display: none;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #007aff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-left: 8px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
</style>
{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Header -->
    <div class="profile-card">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h2>Mon Profil Professionnel</h2>
                <p class="subtitle">Completez votre profil pour recevoir des recommandations personnalisees d'emploi</p>
            </div>
            <div>
                {% if profile.is_complete %}
                <span class="status-badge status-complete">âœ“ Profil complet</span>
                {% else %}
                <span class="status-badge status-incomplete">âš  Profil incomplet</span>
                {% endif %}
            </div>
        </div>
    </div>

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
    {% endif %}

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- Informations Personnelles -->
        <div class="profile-card">
            <h2>Informations Personnelles</h2>
            <p class="subtitle">Coordonnees de base</p>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Nom complet *</label>
                    <input type="text" name="full_name" class="form-input"
                           value="{{ profile.full_name }}" required
                           placeholder="Votre nom complet">
                </div>

                <div class="form-group">
                    <label class="form-label">Telephone</label>
                    <input type="tel" name="phone" class="form-input"
                           value="{{ profile.phone }}"
                           placeholder="+33 6 00 00 00 00">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Ville / Region</label>
                <input type="text" name="location" class="form-input"
                       value="{{ profile.location }}"
                       placeholder="Ex : Paris, Lyon, Marseille">
                <p class="help-text">Votre localisation actuelle</p>
            </div>
        </div>

        <!-- Curriculum Vitae -->
        <div class="profile-card">
            <h2>Curriculum Vitae</h2>
            <p class="subtitle">Telechargez votre CV et l'IA extraira les informations automatiquement</p>

            <div class="cv-section">
                {% if profile.cv_analyzed and profile.curriculum_text %}
                <div class="analyzed-data" style="margin-bottom: 20px;">
                    <h4>âœ“ CV Analyse</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; margin-bottom: 15px;">
                        <pre style="white-space: pre-wrap; font-family: inherit; margin: 0; font-size: 0.9em;">{{ profile.curriculum_text }}</pre>
                    </div>
                </div>
                {% endif %}

                <div class="form-group">
                    <label class="form-label">{% if profile.cv_analyzed %}Mettre a jour le CV{% else %}Telecharger le CV{% endif %} (PDF ou image)</label>
                    <input type="file" name="cv_file" id="cv_file_input" class="form-input" accept="image/*,.pdf">
                {% if profile.curriculum_file %}
                <p class="help-text">Fichier actuel : {{ profile.curriculum_file.name }}</p>
                {% endif %}
                <p class="help-text">Telechargez un PDF et cliquez sur "Analyser le CV avec IA" pour extraire et analyser automatiquement</p>
            </div>
        </div>

        <!-- Preferences de Recherche -->
        <div class="profile-card">
            <h2>Preferences de Recherche</h2>
            <p class="subtitle">Quel type de travail recherchez-vous ?</p>

            <div class="form-group">
                <label class="form-label">Localisations preferees</label>
                <div class="tags-container" id="locations_container">
                    <input type="text" class="tags-input" id="locations_input"
                           placeholder="Ecrivez et appuyez sur Entree...">
                </div>
                <input type="hidden" name="preferred_locations" id="preferred_locations"
                       value='{{ preferred_locations_json|default:"[]" }}'>
                <p class="help-text">Villes ou vous aimeriez travailler (ex : Paris, Teletravail, Lyon)</p>
            </div>

            <div class="form-group">
                <label class="form-label">Secteurs d'interet</label>
                <div class="tags-container" id="sectors_container">
                    <input type="text" class="tags-input" id="sectors_input"
                           placeholder="Ecrivez et appuyez sur Entree...">
                </div>
                <input type="hidden" name="preferred_sectors" id="preferred_sectors"
                       value='{{ preferred_sectors_json|default:"[]" }}'>
                <p class="help-text">Secteurs dans lesquels vous souhaitez travailler (ex : Informatique/IT, Marketing)</p>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Type de travail</label>
                    <div class="tags-container" id="job_types_container">
                        <input type="text" class="tags-input" id="job_types_input"
                               placeholder="Teletravail, Presentiel, Hybride...">
                    </div>
                    <input type="hidden" name="job_types" id="job_types"
                           value='{{ job_types_json|default:"[]" }}'>
                </div>

                <div class="form-group">
                    <label class="form-label">Type de contrat</label>
                    <div class="tags-container" id="contract_types_container">
                        <input type="text" class="tags-input" id="contract_types_input"
                               placeholder="CDI, CDD...">
                    </div>
                    <input type="hidden" name="contract_types" id="contract_types"
                           value='{{ contract_types_json|default:"[]" }}'>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Salaire minimum (â‚¬/an)</label>
                    <input type="number" name="salary_min" class="form-input"
                           value="{{ profile.salary_min|default:'' }}"
                           placeholder="20000">
                </div>

                <div class="form-group">
                    <label class="form-label">Salaire maximum (â‚¬/an)</label>
                    <input type="number" name="salary_max" class="form-input"
                           value="{{ profile.salary_max|default:'' }}"
                           placeholder="50000">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Disponibilite</label>
                <select name="availability" class="form-select">
                    <option value="">Selectionnez...</option>
                    <option value="Inmediata" {% if profile.availability == 'Inmediata' %}selected{% endif %}>Immediate</option>
                    <option value="15 dÃ­as" {% if profile.availability == '15 dÃ­as' %}selected{% endif %}>15 jours</option>
                    <option value="1 mes" {% if profile.availability == '1 mes' %}selected{% endif %}>1 mois</option>
                    <option value="2 meses" {% if profile.availability == '2 meses' %}selected{% endif %}>2 mois ou plus</option>
                </select>
            </div>
        </div>

        <!-- Reseaux Professionnels -->
        <div class="profile-card">
            <h2>Reseaux Professionnels</h2>
            <p class="subtitle">Vos profils en ligne</p>

            <div class="form-group">
                <label class="form-label">LinkedIn</label>
                <input type="url" name="linkedin_url" class="form-input"
                       value="{{ profile.linkedin_url }}"
                       placeholder="https://www.linkedin.com/in/votre-profil">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">GitHub</label>
                    <input type="url" name="github_url" class="form-input"
                           value="{{ profile.github_url }}"
                           placeholder="https://github.com/votre-utilisateur">
                </div>

                <div class="form-group">
                    <label class="form-label">Portfolio / Web</label>
                    <input type="url" name="portfolio_url" class="form-input"
                           value="{{ profile.portfolio_url }}"
                           placeholder="https://votre-portfolio.com">
                </div>
            </div>
        </div>

        <!-- Submit -->
        <div style="text-align: center; margin-top: 24px;">
            <button type="submit" class="btn btn-primary" style="min-width: 200px;">
                ðŸ’¾ Enregistrer le Profil
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Tags functionality
function initTags(containerId, inputId, hiddenId) {
    const container = document.getElementById(containerId);
    const input = document.getElementById(inputId);
    const hidden = document.getElementById(hiddenId);

    let tags = [];
    try {
        tags = JSON.parse(hidden.value) || [];
    } catch (e) {
        tags = [];
    }

    function renderTags() {
        // Remove existing tags
        container.querySelectorAll('.tag').forEach(t => t.remove());

        // Add tags before input
        tags.forEach((tag, index) => {
            const tagEl = document.createElement('span');
            tagEl.className = 'tag';
            tagEl.innerHTML = `${tag}<span class="tag-remove" data-index="${index}">&times;</span>`;
            container.insertBefore(tagEl, input);
        });

        // Update hidden input
        hidden.value = JSON.stringify(tags);
    }

    function addTag(value) {
        value = value.trim();
        if (value && !tags.includes(value)) {
            tags.push(value);
            renderTags();
        }
    }

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addTag(this.value);
            this.value = '';
        }
    });

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('tag-remove')) {
            const index = parseInt(e.target.dataset.index);
            tags.splice(index, 1);
            renderTags();
        } else {
            input.focus();
        }
    });

    renderTags();
}

// Initialize all tag inputs
document.addEventListener('DOMContentLoaded', function() {
    initTags('locations_container', 'locations_input', 'preferred_locations');
    initTags('sectors_container', 'sectors_input', 'preferred_sectors');
    initTags('job_types_container', 'job_types_input', 'job_types');
    initTags('contract_types_container', 'contract_types_input', 'contract_types');
});

// CV Analysis - handles both text and PDF
document.getElementById('analyze_cv_btn').addEventListener('click', function() {
    const cvText = document.getElementById('cv_text').value.trim();
    const fileInput = document.getElementById('cv_file_input');
    const file = fileInput.files[0];

    // Check if we have PDF or text
    const hasPdf = file && file.name.toLowerCase().endsWith('.pdf');
    const hasText = cvText && cvText.length >= 50;

    if (!hasPdf && !hasText) {
        alert('Veuillez telecharger un PDF ou ecrire au moins 50 caracteres sur votre experience professionnelle.');
        return;
    }

    const btn = this;
    const spinner = document.getElementById('cv_spinner');
    const resultDiv = document.getElementById('cv_analysis_result');
    const cvTextArea = document.getElementById('cv_text');

    btn.disabled = true;
    spinner.style.display = 'inline-block';
    resultDiv.innerHTML = '<p>Analyse de votre CV en cours...</p>';

    // If PDF, first extract text then analyze
    if (hasPdf) {
        resultDiv.innerHTML = '<p>Extraction du texte du PDF...</p>';

        const formData = new FormData();
        formData.append('pdf_file', file);

        fetch('{% url "apps_company:extract_pdf" %}', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Put extracted text in textarea
                cvTextArea.value = data.text;
                resultDiv.innerHTML = '<p>Analyse du CV avec IA...</p>';
                // Now analyze the extracted text
                return analyzeText(data.text);
            } else {
                throw new Error(data.error);
            }
        })
        .then(analysisData => {
            btn.disabled = false;
            spinner.style.display = 'none';
            showAnalysisResult(analysisData, resultDiv);
        })
        .catch(error => {
            btn.disabled = false;
            spinner.style.display = 'none';
            resultDiv.innerHTML = `<div class="alert alert-error">Erreur : ${error.message}</div>`;
        });
    } else {
        // Just analyze the text
        analyzeText(cvText)
        .then(data => {
            btn.disabled = false;
            spinner.style.display = 'none';
            showAnalysisResult(data, resultDiv);
        })
        .catch(error => {
            btn.disabled = false;
            spinner.style.display = 'none';
            resultDiv.innerHTML = `<div class="alert alert-error">Erreur : ${error.message}</div>`;
        });
    }
});

function analyzeText(text) {
    return fetch('{% url "apps_company:analyze_cv" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: 'cv_text=' + encodeURIComponent(text)
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            throw new Error(data.error);
        }
        return data;
    });
}

function showAnalysisResult(data, resultDiv) {
    let html = '<div class="analyzed-data"><h4>âœ“ CV analyse correctement</h4>';

    if (data.data.skills && data.data.skills.length > 0) {
        html += '<p><strong>Competences detectees :</strong></p><div>';
        data.data.skills.forEach(skill => {
            html += `<span class="skill-tag">${skill}</span>`;
        });
        html += '</div>';
    }

    if (data.data.professional_summary) {
        html += `<p style="margin-top: 12px;"><strong>Resume :</strong> ${data.data.professional_summary}</p>`;
    }

    if (data.data.suggested_job_titles && data.data.suggested_job_titles.length > 0) {
        html += `<p style="margin-top: 12px;"><strong>Postes suggeres :</strong> ${data.data.suggested_job_titles.join(', ')}</p>`;
    }

    html += '<p style="margin-top: 12px; color: #28a745;"><strong>Votre profil a ete mis a jour. Enregistrez les modifications.</strong></p>';
    html += '</div>';

    resultDiv.innerHTML = html;
}
</script>
{% endblock %}
